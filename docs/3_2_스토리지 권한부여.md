오퍼레이터, 관리자, 클러스터 관리자가 공유할 **공유 스토리지**

**Azure Cloud Shell**에서 사용하도록 **Azure Storage Account**와 **파일 공유(Azure Files)** 로 구성  

## **3. Azure AD 기반 RBAC 권한 할당**
Azure AD 그룹을 생성하고, 이를 Azure Files에 연결하여 역할 기반 접근 제어(RBAC)를 설정할 수 있습니다.

### **3.1 오퍼레이터, 관리자 외 그룹 생성**
```sh
SUBSCRIPTION_ID=$(az account show --query id --output tsv)
az account set --subscription $SUBSCRIPTION_ID
LOCATION="koreacentral"

STORAGE_ACCOUNT_NAME=akscloudshellstorage
RESOURCE_GROUP=rg-aks-cloudshell
LOCATION=koreacentral

OPERATOR_GROUP="aks-operators"
ADMIN_GROUP="aks-admins"
CLUSTER_MANAGER_GROUP="aks-cluster-managers"
DEVELOPERS_GROUP="aks-developers"

# 각 그룹의 Object ID 가져오기
OPERATOR_GROUP_OBJECT_ID=$(az ad group show --group aks-operators --query id --output tsv)
ADMIN_GROUP_OBJECT_ID=$(az ad group show --group aks-admins --query id --output tsv)
CLUSTER_ADMIN_GROUP_OBJECT_ID=$(az ad group show --group aks-cluster-admins --query id --output tsv)
DEVELOPER_GROUP_OBJECT_ID=$(az ad group show --group aks-developers --query id --output tsv)

echo "🔹 그룹 정보:"
echo "   - 오퍼레이터: $OPERATOR_GROUP_OBJECT_ID"
echo "   - 관리자: $ADMIN_GROUP_OBJECT_ID"
echo "   - 클러스터 관리자: $CLUSTER_ADMIN_GROUP_OBJECT_ID"
echo "   - 개발자: $DEVELOPER_GROUP_OBJECT_ID"
```

### **3.2 스토리지 권한 부여**
Azure Files에 대한 `Storage File Data SMB Share Contributor` 역할을 할당하여 사용자가 읽기/쓰기/삭제가 가능하도록 설정합니다.

읽기 가능하게 하려면 `Storage File Data SMB Share Reader` 역할을 할당합니다.

```sh
az role assignment create \
  --assignee $OPERATOR_GROUP_OBJECT_ID \
  --role "Storage File Data SMB Share Reader" \
  --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT_NAME"

az role assignment create \
  --assignee $ADMIN_GROUP_OBJECT_ID \
  --role "Storage File Data SMB Share Contributor" \
  --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT_NAME"

az role assignment create \
  --assignee $CLUSTER_ADMIN_GROUP_OBJECT_ID \
  --role "Storage File Data SMB Share Contributor" \
  --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT_NAME"

az role assignment create \
  --assignee $DEVELOPER_GROUP_OBJECT_ID \
  --role "Storage File Data SMB Share Reader" \
  --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT_NAME"

# # 삭제
# az role assignment delete \
#   --assignee $OPERATOR_GROUP_OBJECT_ID \
#   --role "Storage File Data SMB Share Contributor"  \
#   --scope "/subscriptions/$SUBSCRIPTION_ID/resourceGroups/$RESOURCE_GROUP/providers/Microsoft.Storage/storageAccounts/$STORAGE_ACCOUNT_NAME"
```

```

> **참고:** `Storage File Data SMB Share Contributor` 역할은 Azure Files를 사용할 때 필요하며, 개별 사용자 또는 그룹의 **Azure AD Object ID**를 설정해야 합니다.

---
